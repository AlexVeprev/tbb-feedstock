{% set version = "2018.0.3" %}
{% set vtag = "2018_U3" %}
{% set vinterface = 10003 %}

{% set build = 'python build/build.py --make-tool=mingw32-make --build-prefix=vc%VS_MAJOR%' %}  # [win]
{% set build = 'python build/build.py --build-args=stdver=c++11' %}                             # [unix]

package:
  name: tbb
  version: {{ version }}

source:
  fn: tbb{{ vtag }}_oss_src.tgz
  url: https://github.com/01org/tbb/archive/{{ vtag }}.tar.gz
  sha256: 23793c8645480148e9559df96b386b780f92194c80120acce79fcdaae0d81f45

build:
  number: 1
  script_env:
    - OS    # [win]

requirements:
  build:
    - toolchain
    - python
    - swig
    - {{ compiler('cxx') }}
    - m2w64-make                                         # [win]

test:
  requires:
    - python *               # any python version is ok for sake of testing of shared libraries
  commands:
    - python -c "import ctypes; assert {{ vinterface }} == ctypes.cdll[r'libtbb.so.2']       ['TBB_runtime_interface_version']()"  # [linux]
    - python -c "import ctypes; assert {{ vinterface }} == ctypes.cdll[r'libtbb${SHLIB_EXT}']['TBB_runtime_interface_version']()"  # [unix and not linux]
    - python -c "import ctypes; assert {{ vinterface }} == ctypes.cdll[r'tbb.dll']           ['TBB_runtime_interface_version']()"  # [win]

outputs:
  - name: tbb
    build:
      script: {{ build }} --install-libs
      binary_relocation: False

  - name: tbb-devel
    build:
      script: {{ build }} --no-rebuild --install-devel --install-docs
      binary_relocation: False
    requirements:
      host:
        - {{ compiler('cxx') }}
        - m2w64-make                                     # [win]
      run:
        - {{ pin_subpackage('tbb', exact=True) }}        # development package is for specific version of tbb
    test:
      commands:
        - if not exist %LIBRARY_INC%\\tbb\\tbb.h exit 1  # [win]
        - if not exist %LIBRARY_LIB%\\tbb.lib exit 1     # [win]
        - test -f ${PREFIX}/include/tbb/tbb.h            # [unix]

  - name: tbb4py
    build:
      script: {{ build }} --no-rebuild --install-python
      entry_points:
        - python-tbb = tbb:_main
    requirements:
      host:
        - {{ compiler('cxx') }}
        - m2w64-make                                     # [win]
        - python
        - swig
        - {{ pin_subpackage('tbb-devel', exact=True) }}
      run:
        - tbb >={{ version }}                            # while python module works with any compatible tbb...
        - python
    test:
      requires:
        - python
        - {{ pin_subpackage('tbb', exact=True) }}        # we want to test with this specific tbb package
      imports:
        - tbb
        - TBB
      commands:
        - python-tbb -h
        - python -m TBB -h
        - python -m tbb -h
        - python -m tbb test
    about:
      summary: TBB module for Python
      license: Apache 2.0
      dev_url: https://github.com/01org/tbb

about:
  home: http://www.threadingbuildingblocks.org
  license: Apache 2.0
  license_file: LICENSE
  summary: High level abstract threading library
  dev_url: https://github.com/01org/tbb
  doc_url: https://software.intel.com/en-us/node/506039

extra:
  recipe-maintainers:
    - jschueller
    - anton-malakhov
